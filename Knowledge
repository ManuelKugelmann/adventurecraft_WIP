# Knowledge as Virtual Items

*Replaces: knowledge_and_plans.md, secrets.md*

## Core Idea

Knowledge about a thing is a **partial, possibly stale, possibly wrong copy** of that thing. No separate knowledge graph. No belief system. An entity's knowledge is a set of virtual items in its inventory, each mirroring a real entity in the world.

```
RealEntity {
    stats: StatBlock        // the truth
}

VirtualItem {
    mirrors: EntityRef      // what real thing this represents
    stats: StatBlock        // what the knower thinks the stats are (partial, maybe wrong)
    freshness: f32          // when was this last updated
    source: Source           // observed, told, inferred
}
```

A person who "knows about" another person holds a virtual copy of them â€” with whatever subset of stats they've observed or been told. The copy may be incomplete (missing stats they never learned), stale (stats changed since they last checked), or wrong (they were lied to).

This is the same stat block structure the real entity uses, just sparse and potentially inaccurate.

---

## What Gets Mirrored

Any entity type can be mirrored as a virtual item:

**Person/group virtual item**: species, approximate skill levels, equipment tier, location (last known), disposition, action (last observed). Missing fields = unknown. Example: "The northern scouts â€” about 50, lightly armed, last seen near the river pass, seemed hostile."

**Item virtual item**: type, quality tier, location (last known). Example: "There's iron ore in Mine 3" = a virtual item mirroring the real iron deposit, with location filled in but quantity maybe unknown.

**Location virtual item**: terrain type, resources present, connections known, structures present, who occupies it. Example: "The eastern valley â€” fertile, river access, occupied by traders." A map is literally a collection of location virtual items.

**Person/group with nested virtual items**: A group virtual item can contain virtual items representing what the knower thinks *that group* knows/has. This is knowledge about knowledge â€” and knowledge about inventory, plans, everything. It's recursive with no special case.

```
My knowledge about Enemy Faction:
    VirtualItem(EnemyFaction) {
        stats: { strength: ~500, location: FORTRESS_NORTH, mood: aggressive }
        inventory: [
            VirtualItem(SiegeEquipment) { stats: { quantity: ~10 } }
        ]
        knowledge: [
            VirtualItem(OurSecretTunnel) { stats: { location: WEST_WALL } }  // â† I think they know about our tunnel
        ]
        plans: [
            VirtualItem(AttackPlan) { stats: { target: US, timing: SPRING } }  // â† I think they plan to attack
        ]
    }
```

Meta-knowledge isn't a separate system. It's just depth in the virtual item tree. "I know that they know about our tunnel" = my virtual copy of them contains a virtual copy of our tunnel in their knowledge set.

---

## Skills Gate Rules (On Demand)

Skills already represent knowledge of the rules they unlock. No separate knowledge category needed. A Metallurgy:3 skill means "knows how to temper steel." The skill *is* the domain knowledge.

Skill-based knowledge is **checked on demand, never stored**. When an entity interacts with something, the system checks whether their skill level reveals additional information or grants knowledge of specific facts, recipes, or artifacts:

```
Observation (local detail):
    Geology â‰¥ 1 â†’ sees ore type
    Geology â‰¥ 3 â†’ sees vein quality and estimated yield
    Perception â‰¥ 3 â†’ notices concealed weapons

Factual knowledge (asked or relevant):
    History â‰¥ 2 â†’ knows about the Old Kingdom's trade routes
    History â‰¥ 4 â†’ knows the location of the lost archive
    Medicine â‰¥ 3 â†’ recognizes plague symptoms, knows quarantine protocols

Recipes / rules (attempting an action):
    Metallurgy â‰¥ 2 â†’ knows bronze alloy ratio
    Metallurgy â‰¥ 4 â†’ knows crucible steel technique
    Alchemy â‰¥ 3 â†’ knows antidote for common poisons

Artifact identification (encountering an item):
    Arcana â‰¥ 2 â†’ recognizes enchanted items
    Metallurgy â‰¥ 4 â†’ identifies damascus steel, knows its properties
    History â‰¥ 3 â†’ recognizes Old Kingdom craftsmanship, infers origin
```

No virtual items created. No results cached. The skill check is a predicate evaluated at the moment a decision, observation, or question arises. Everything that can be expressed as "anyone with skill X at level Y would know this" is a skill check, not a virtual item.

**Virtual items are reserved for things no skill check can cover**: knowledge that depends on having been in a specific place, met a specific person, or received specific intelligence. "The enemy general is massing troops at the northern pass" is not something History:5 tells you â€” someone had to see it and report it.

A farming village has Farming:3, Metallurgy:1, Combat:1, Medicine:1 as group-level stats. These are just stat block entries â€” skills like any other.

**Virtual items are only for specific, unique knowledge**: the location of a particular mine, the weakness of a particular enemy, a specific trade route, a secret recipe. The split is like equipment: you don't track every nail in a carpenter's toolbox, just "carpentry tools: quality tier 3." But you do track the unique enchanted hammer.

---

## Simulation Rules as Knowledge

A simulation rule is:

```
Rule {
    conditions: StatPredicate[]     // what must be true
    action: ActionType              // what you do
    effects: StatDelta[]            // what changes
    domain: Domain                  // which skill domain
    min_skill: u8                   // minimum skill level to use this rule (0 = base ruleset)
}
```

Rules exist globally. An entity can only *use* a rule if their skill level in the domain meets the minimum. Skill level *is* knowledge of rules in that domain.

Examples:
```
Rule: Smelt iron
    conditions: [has(IRON_ORE), has(FURNACE), region.has(FUEL)]
    action: SMELT
    effects: [consume(IRON_ORE, 1), consume(FUEL, 1), produce(IRON_INGOT, 1)]
    domain: Metallurgy
    min_skill: 1

Rule: Temper steel
    conditions: [has(IRON_INGOT), has(CARBON_SOURCE), has(FORGE)]
    action: TEMPER
    effects: [consume(IRON_INGOT), produce(STEEL_INGOT)]
    domain: Metallurgy
    min_skill: 3

Rule: Exploit wall weakness
    conditions: [has(VirtualItem(WALL_X, structural_integrity < 0.3)), has(SIEGE_EQUIPMENT)]
    action: BREACH
    effects: [destroy(WALL_X)]
    domain: Combat
    min_skill: 2
    // Also requires the specific virtual item â€” you need to *know* which wall is weak
```

### Secret Rules

Some rules are not globally known. A secret recipe, a unique technique, a magical ritual. These are gated by possessing a specific virtual item rather than (or in addition to) skill level:

```
Rule: Damascus steel technique
    conditions: [has(IRON_INGOT), has(SPECIAL_FLUX), has(VirtualItem(DAMASCUS_RECIPE))]
    action: FORGE_DAMASCUS
    effects: [produce(DAMASCUS_STEEL)]
    domain: Metallurgy
    min_skill: 2                   // need basic competence + the recipe
```

The recipe itself is a virtual item that can be copied (taught), stolen (espionage), or discovered (research). Its rarity is controlled by obscurity â€” copying doesn't destroy the original, but high obscurity limits who gets a copy.

---

## Secrecy as a Stat

Secrecy is not a separate system. It's a property of knowledge items:

```
VirtualItem {
    mirrors: EntityRef
    stats: StatBlock
    freshness: f32
    source: Source
    obscurity: f32          // 0.0 = common knowledge, 1.0 = deeply hidden
}
```

**Obscurity** controls how hard the virtual item is to acquire through passive means:

- **obscurity â‰ˆ 0**: Freely propagates through social contact. Location of the town well. Name of the king. Basic trade prices. Propagates like any other stat during group merge/split.

- **obscurity â‰ˆ 0.3**: Spreads within a community but not beyond. Local gossip, guild common knowledge, neighborhood events. Propagates within faction, attenuated across faction boundaries.

- **obscurity â‰ˆ 0.6**: Restricted. Military deployments, trade secrets, ongoing negotiations. Only propagates via deliberate teaching or dedicated communication channels. Requires access (faction membership, clearance level).

- **obscurity â‰ˆ 0.9**: Deep secret. Assassination plot, hidden passages, spy identities. Does not propagate passively at all. Can only be acquired through direct observation, deliberate sharing by a holder, or espionage.

- **obscurity â‰ˆ 1.0**: Unknown unknown. Nobody is even looking for this because they don't know it exists. Hidden facts about the world (undiscovered ore vein, forgotten ruins). Can only be acquired through research or accidental discovery.

### Obscurity Interacts With Existing Propagation

During social propagation between co-located groups (already modeled), the propagation chance for each virtual item is modified by obscurity:

```
propagation_chance = base_social_spread Ã— (1.0 - obscurity) Ã— proximity Ã— faction_affinity
```

High obscurity items simply don't spread. No separate containment system needed. The holder doesn't need to "spend effort" keeping a secret â€” the obscurity value already suppresses propagation. 

### Obscurity Changes

Obscurity isn't fixed. It changes based on events:

**Obscurity decreases** (secret becomes more known):
- More entities acquire copies (each copy is a potential leak source)
- Physical evidence becomes harder to hide (troop movements are visible)
- Time passes and holders become careless
- A holder is captured or defects

**Obscurity increases** (harder to discover):
- Holders are eliminated (fewer copies exist)
- Evidence is destroyed
- Counter-intelligence succeeds (leak sources identified and removed)
- Cover story is established (a competing false virtual item at lower obscurity displaces the true one)

The rate of change:
```
obscurity_drift = -copy_count Ã— EXPOSURE_RATE          // more copies â†’ less obscure
                  -evidence_visibility Ã— EVIDENCE_RATE   // physical evidence erodes secrecy
                  +containment_effort Ã— SUPPRESSION_RATE // active effort maintains secrecy
```

### Cover Stories

A cover story is simply a **false virtual item at lower obscurity** that competes with the true one. When an entity encounters both, the one with lower obscurity (more accessible) is encountered first. If it's plausible (no contradicting observations), the entity accepts it and stops looking.

```
True:  VirtualItem(TUNNEL, destination=ENEMY_FORTRESS, obscurity=0.9)
Cover: VirtualItem(TUNNEL, destination=NEW_MINE, obscurity=0.3)

Outside observers encounter the cover first. 
They'd need to overcome the 0.9 obscurity to find the truth.
The cover provides a plausible explanation that satisfies curiosity.
```

If the cover is busted (someone follows the tunnel and sees it goes to the fortress), they gain the true virtual item at Observed source, and the cover's credibility collapses for them. They may then spread the truth, which lowers the true item's obscurity for everyone else.

---

## Knowledge Propagation Revisited

With virtual items, propagation is item transfer â€” the same operation as any other inventory exchange, with one exception: **copying doesn't consume the original**.

### Passive spread (social)
Co-located groups exchange low-obscurity virtual items automatically. Rate proportional to group sizes and affinity. Items with obscurity > threshold don't spread this way.

### Teaching
Deliberate transfer. A teacher node copies a virtual item (or raises a skill level) in a student node. Rate limited by teacher skill, student capacity, and connection throughput. Can transfer higher-obscurity items than passive spread.

### Observation
Within observation range (current + adjacent regions), entities query world state directly â€” no virtual items created. Virtual items are only created when an entity **leaves** a region (snapshot of what they saw) or observes something hidden that requires active investigation (scouting, prospecting, research).

### Espionage
A solo leaf infiltrates a target and copies virtual items from the target's knowledge set. This is the only way to acquire items at obscurity > 0.8 without being the original observer. The spy's skill determines copy quality and detection risk.

### Research
Produces new virtual items for things that weren't previously known to anyone. The world has real entities with real stats â€” research creates the first virtual item copy of a previously uncopied entity or stat.

### Forgetting
Virtual items with low freshness can be dropped during coarsening. A group that merges may lose niche knowledge that only a few members held. This is the natural knowledge loss mechanism. Important knowledge (high-use, high-relevance) stays; trivia fades.

---

## Plans Revisited

A plan is a virtual item that mirrors a **future state** rather than a current entity:

```
VirtualItem(Plan) {
    mirrors: FUTURE_STATE          // what we want the world to look like
    stats: {
        goal: StatPredicate[]      // desired conditions
        steps: ActionSequence      // how to get there
        assumptions: VirtualItem[] // knowledge items the plan depends on
        confidence: f32            // product of assumption freshness/accuracy
    }
    obscurity: f32                 // how secret is this plan
}
```

Plans are knowledge items like any other. They can be:
- Shared (taught to subordinates â€” lowers obscurity within faction)
- Stolen (espionage copies the plan virtual item)
- Stale (assumptions are virtual items that may no longer match reality)
- Wrong (based on inaccurate virtual items)

Plan validity is just: do the assumption virtual items still match the real entities they mirror? If the real entity's stats have diverged from the virtual copy's stats, the plan's confidence drops.

---

## Full Model

Knowledge resolves through three mechanisms, all stateless except the last:

```
1. Base rules + local observation + role scope  â†’  query world state (free, always current)
2. stats.skills: Map<Domain, u8>                â†’  on-demand checks reveal detail / gate rules
3. stats.knowledge_items: VirtualItem[]         â†’  specific knowledge about remote/hidden/unique things
```

Tiers 1 and 2 store nothing â€” they're evaluated when needed. Only tier 3 has runtime cost.

Where VirtualItem is:
```
VirtualItem {
    mirrors: EntityRef          // what real entity this represents (or FUTURE_STATE for plans)
    stats: StatBlock            // partial, possibly wrong copy
    freshness: f32              // age of information
    source: Source              // observed, taught, inferred, stolen
    obscurity: f32              // propagation resistance
}
```

That's it. No separate belief system, no containment structures, no meta-belief types. Knowledge about a person is a virtual copy of them. Knowledge about what they know is a virtual copy of them that includes virtual copies in their knowledge slot. Secrecy is the obscurity stat on the virtual item. Plans are virtual items mirroring desired future states. Simulation rules are globally defined but gated by skill levels and specific virtual item possession.

---

## What Doesn't Need Representation

Three large classes of knowledge are free â€” no virtual items needed:

### Base Ruleset (Global)

The fundamental simulation rules are known to everyone. Smelting needs ore and heat. Crops need water and soil. Swords hurt people. These are the game's physics â€” no entity needs to "learn" them. They're queryable from a global rule table unconditionally.

```
Base (free):       fire burns, rain makes mud, food spoils, walls block movement
Gated (skill):     iron smelting, wound treatment, siege tactics, alloy ratios
Specific (v-item): this wall is weak, the secret recipe, the tunnel location
```

### Skills Include Rule Knowledge

A skill level already represents knowledge of the rules that skill unlocks. Metallurgy:3 means "knows how to temper steel" â€” there's no separate knowledge category needed. Skills *are* the knowledge categories.

Advanced rules are gated by skill level. The rule table says "tempering requires Metallurgy â‰¥ 3." If you have the skill, you know the rule. No duplication.

### Local Observable Geography + Role-Based Local Knowledge

An entity in a region can directly query that region's terrain, structures, connections, and visible occupants from the world state. No virtual item needed.

Beyond raw observation, a group's **role implies local knowledge** about their area of work. Miners at Mine 3 know Mine 3's vein quality, remaining capacity, and hazards â€” not because they carry virtual items about it, but because their role + location is a direct query key into the world state. Guards at the north gate know traffic patterns and fortification state. Farmers on the east fields know soil quality and irrigation status.

```
Query: what does this group know about?
    1. World state within observation range        (everyone)
    2. Detailed world state for their role+region  (role-specific depth)
    3. Virtual items for everything else            (remote, hidden, unique)
```

This means:
- No "map" virtual items for regions you're standing in or adjacent to
- No location virtual items for structures you can see
- No detailed knowledge items for things your role already covers locally
- Miners don't carry virtual items about their own mine
- Guards don't carry virtual items about their own fortifications

Virtual items for geography only exist for **remote or previously-visited locations** â€” knowledge of places you can't currently observe. A scout who visited the eastern valley carries virtual items for it because they're no longer there. A faction leader has virtual items for distant provinces based on reports.

The boundary: **observation range + role scope**. Inside it, query the world. Outside it, you need virtual items, and those items may be stale.

```
Knowledge source:
    Current region + neighbors              â†’  query world state (free, accurate)
    Role-specific depth at work location    â†’  query world state (free, accurate, detailed)
    Beyond observation range / role scope   â†’  virtual items (possibly stale/wrong)
    Never visited/reported                  â†’  unknown (no virtual item exists)
```

This dramatically reduces virtual item count. Most entities carry zero virtual items â€” their world is fully covered by direct observation and role knowledge.

---

## Cost

| Operation | Cost |
|---|---|
| Base rules + local geography + role knowledge | Zero â€” queried from world state |
| Skills (including rule knowledge) | Part of stat block, free |
| Virtual items per node | O(0-20 typical) â€” only remote/hidden/unique knowledge |
| Passive propagation | Filtered by obscurity threshold â€” most items skip the check |
| Copying on teach/espionage | One virtual item duplication |
| Freshness decay | O(virtual_items) per tick, batch-able |
| Plan validation | O(assumptions per plan), ~3-10 checks |
| Meta-knowledge depth | Rarely > 2 levels deep in practice â€” exponential cost self-limits |

Most entities (farmers, laborers, soldiers in garrison) carry zero virtual items â€” their world is fully covered by direct observation, role-based local knowledge, and skills. Only scouts, traders, spies, and leaders accumulate significant virtual item inventories.
