# Spatial Hierarchy

## Single Node Type

The spatial world is a tree. Every level is the same node.

```
World → Province → Zone → Region → TileGroup → Tile
```

```
SpatialNode {
    children: [SpatialNode],
    owner: EntityRef?,             // legal claim
    holder: EntityRef?,            // physical occupant/tenant
    tags: [ZoneTag],               // purpose designation
    contents: [BulkGroup],         // stored objects (bulk)
    special_items: [ObjectId],     // materialized individual objects
}
```

No separate room, zone, container, vehicle concepts. Just spatial tree nodes at different depths with different tile properties and tags.

---

## Derived Properties

Computed from child tiles on demand, not stored.

```
node.enclosed     = all boundary tiles have walls
node.roofed       = all tiles have ceiling
node.area         = tiles.len()
node.capacity     = f(area, ceiling_height)
node.temperature  = f(enclosed, roofed, ambient, insulation, heat_sources)
node.light        = f(roofed, windows, light_sources, time_of_day)
node.access       = boundary tiles with openings
```

---

## Everything Is a Spatial Node

| Example | Enclosed | Roofed | Tags |
|---|---|---|---|
| Kitchen | yes | yes | `[cooking, storage.food]` |
| Workshop | yes | yes | `[smithing, storage.metal]` |
| Barracks | yes | yes | `[sleeping, military]` |
| Market square | no | no | `[trading, gathering]` |
| Farm field | no | no | `[farming]` |
| Mine shaft | yes | yes (rock) | `[mining, storage.ore]` |
| Courtyard | no | partial | `[gathering, training]` |
| Stable | partial | yes | `[animals, storage.feed]` |
| Ship deck | yes | no | `[navigation, combat]` |
| Ship hold | yes | yes | `[storage.cargo]` |
| Forest clearing | no | no | `[foraging, camping]` |
| Cave | yes | yes (rock) | `[shelter, mining]` |

---

## Detection

Spatial nodes detected algorithmically from tile layout:

```
// Flood-fill from walls/boundaries → enclosed regions
// Tags assigned by:
//   - Furniture/objects present ("hearth + prep_surface → cooking")
//   - Player designation ("this area is farming")
//   - Template ("place kitchen blueprint here")
```

---

## Buildings = Parent Nodes

A building is a spatial node whose children are room nodes.

```
Tavern (SpatialNode, tags: [commercial, social])
├── Common room (tags: [gathering, eating])
│   contents: [furniture.tavern: 10, tools.cooking: 3, fuel: 5]
├── Kitchen (tags: [cooking, storage.food])
│   contents: [tools.cooking: 8, furniture.kitchen: 4, food.grain: 50]
├── Room 1 (tags: [sleeping, rental])
│   contents: [furniture.bedroom: 3]
├── Room 2 (tags: [sleeping, rental])
│   contents: [furniture.bedroom: 3]
└── Cellar (tags: [storage.drink, storage.food])
    contents: [drink.ale: 40, food.preserved: 20]
```

A district is a parent of building nodes. A settlement is a parent of district nodes. Same structure all the way up.

---

## Vehicles = Moving Subtrees

A vehicle is a spatial subtree whose tiles have a shared velocity.

```
Vehicle = SpatialNode + MovementStats {
    speed: f32,
    terrain_types: [TerrainType],
    position: LocationRef,           // current world position
}
```

A cart: single spatial node that moves.

A ship: subtree with multiple child nodes.

```
Merchant Ship (SpatialNode, tags: [transport, naval])
├── Deck (tags: [navigation, combat])
│   contents: [tools.naval: 5, weapons.ship: 2]
├── Hold (tags: [storage.cargo])
│   contents: [trade_goods: 200, food.preserved: 50]
├── Cabin (tags: [sleeping, command])
│   contents: [furniture.cabin: 4, tools.navigation: 2]
└── Galley (tags: [cooking])
    contents: [tools.cooking: 3, fuel: 10]
```

---

## Tags Drive Actions

Zone tags determine which roles/actions can operate in a spatial node.

```
CRAFT(food_recipe)    needs tags: [cooking]
CRAFT(iron_sword)     needs tags: [smithing]
TRADE(goods)          needs tags: [trading]
REST                  needs tags: [sleeping]
TRAIN(combat)         needs tags: [training]
RESEARCH              needs tags: [library] or [laboratory]
```

The node's bulk groups provide tool bonuses. Same system whether it's a stone kitchen or an open-air cooking pit — just different derived stats.

---

## Owner / Holder on Spatial Nodes

Same distinction as objects:

| Situation | Owner | Holder |
|---|---|---|
| Lord's castle room | lord | lord |
| Rented market stall | market_guild | merchant |
| Occupied enemy fort | original_faction | invading_faction |
| Abandoned mine | null | null |
| Squatted building | original_owner | squatters |
| Leased farmland | landowner | tenant_farmer |

Contracts bind owner↔holder relationships. Eviction = removing holder via authority claim. Conquest = forcibly changing holder, then disputing/replacing owner.

---

## Containers Are Just Nodes

Portable containers (backpack, chest, barrel) are the same as spatial containers — just smaller, moveable, and not tile-derived.

```
Portable: Object with Container(capacity) trait → has contents/special_items
Spatial:  SpatialNode derived from tiles → has contents/special_items
```

Both hold BulkGroups and special_items. Both have owner/holder. Same rules, same queries. A chest inside a room is a child node. A backpack on a person is a child node of the entity.
